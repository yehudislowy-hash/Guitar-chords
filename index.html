<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Guitar Chords</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Category Selection Screen */
        .category-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .category-screen h1 {
            color: white;
            font-size: 3em;
            margin-bottom: 50px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .category-buttons {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-btn {
            padding: 40px 60px;
            font-size: 1.8em;
            background: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: 600;
            color: #667eea;
        }

        .category-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .tuner-btn-home {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 15px 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tuner-btn-home:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main App Screen */
        .app-screen {
            display: none;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .back-btn {
            padding: 12px 25px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #667eea;
        }

        .app-title {
            color: white;
            font-size: 2em;
            flex: 1;
            text-align: center;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            padding: 12px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Browse Options */
        .browse-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .browse-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
            color: #667eea;
        }

        .browse-btn.active {
            background: #667eea;
            color: white;
        }

        /* Search and Add */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .add-song-btn {
            padding: 15px 30px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .add-song-btn:hover {
            background: #38a169;
        }

        .shuffle-btn {
            padding: 15px 30px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Songs List */
        .songs-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .songs-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .song-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .song-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }

        .song-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .song-item-info {
            flex: 1;
        }

        .song-item-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
        }

        .song-item-artist {
            color: #718096;
            font-size: 0.9em;
        }

        .artist-group {
            margin-bottom: 30px;
        }

        .artist-header {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        /* Song View Screen */
        .song-view-screen {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .song-view-header {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .song-view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #5568d3;
        }

        .song-info-section {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .song-album-art {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .song-details {
            flex: 1;
        }

        .song-title-view {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .song-artist-view {
            font-size: 1.3em;
            color: #718096;
            margin-bottom: 15px;
        }

        .capo-info {
            display: inline-block;
            padding: 8px 15px;
            background: #fbd38d;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .chords-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background: #edf2f7;
            border-radius: 10px;
        }

        .chord-tag {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .capo-transpose {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .capo-transpose label {
            font-weight: 600;
        }

        .capo-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 2px solid #667eea;
            font-size: 1em;
        }

        /* Song Content */
        .song-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .chord-line {
            color: #e53e3e;
            font-weight: 700;
            font-size: var(--text-size, 16px);
            letter-spacing: 0.5px;
        }

        .lyric-line {
            color: #2d3748;
            font-size: var(--text-size, 16px);
        }

        /* YouTube Player */
        .youtube-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .youtube-player {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 10px;
        }

        /* Scroll Controls */
        .scroll-controls {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        }

        .scroll-btn {
            padding: 12px 25px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
        }

        .scroll-btn.stop {
            background: #f56565;
        }

        .scroll-speed {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .speed-slider {
            flex: 1;
            min-width: 200px;
        }

        .text-size-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .size-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.8em;
            font-weight: 700;
            color: #2d3748;
        }

        .close-modal {
            font-size: 2em;
            background: none;
            border: none;
            cursor: pointer;
            color: #718096;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            font-family: 'Courier New', monospace;
            min-height: 300px;
            resize: vertical;
        }

        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e6f0ff;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            margin: 20px 0;
            border-radius: 10px;
        }

        .processing-text {
            color: #667eea;
            font-weight: 600;
            margin: 15px 0;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #38a169;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tuner Modal */
        .tuner-screen {
            text-align: center;
        }

        .tuner-display {
            margin: 30px 0;
        }

        .tuner-meter {
            width: 100%;
            max-width: 400px;
            height: 100px;
            background: #edf2f7;
            border-radius: 50px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }

        .tuner-needle {
            width: 4px;
            height: 80px;
            background: #48bb78;
            position: absolute;
            left: 50%;
            top: 10px;
            transform: translateX(-50%);
            transition: all 0.1s;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
        }

        .tuner-marks {
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            font-weight: 600;
            color: #718096;
        }

        .tuner-status {
            font-size: 2em;
            font-weight: 700;
            margin: 20px 0;
            min-height: 40px;
        }

        .tuner-status.in-tune {
            color: #48bb78;
        }

        .tuner-status.flat {
            color: #f56565;
        }

        .tuner-status.sharp {
            color: #ed8936;
        }

        .string-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .string-btn {
            padding: 20px;
            font-size: 1.5em;
            font-weight: 700;
            background: #e2e8f0;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .string-btn.active {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .string-btn:hover {
            background: #cbd5e0;
        }

        .tuner-note {
            font-size: 3em;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Category Selection Screen -->
    <div class="category-screen" id="categoryScreen">
        <button class="tuner-btn-home" onclick="openTuner()">üé∏ Tuner</button>
        <h1>üé∏ My Guitar Chords</h1>
        <div class="category-buttons">
            <button class="category-btn" onclick="selectCategory('jewish')">Jewish Music</button>
            <button class="category-btn" onclick="selectCategory('nonJewish')">Non-Jewish Music</button>
        </div>
    </div>

    <!-- Main App Screen -->
    <div class="app-screen" id="appScreen">
        <div class="app-header">
            <button class="back-btn" onclick="goBackToCategories()">‚Üê Back</button>
            <h2 class="app-title" id="categoryTitle">Jewish Music</h2>
            <div class="header-controls">
                <button class="icon-btn" onclick="openTuner()">üé∏ Tuner</button>
            </div>
        </div>

        <div class="browse-options">
            <button class="browse-btn active" onclick="setBrowseMode('name')">Song Name (A-Z)</button>
            <button class="browse-btn" onclick="setBrowseMode('artist')">By Artist</button>
        </div>

        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="Search songs..." oninput="searchSongs()">
            <button class="shuffle-btn" onclick="shuffleSong()">üîÄ Shuffle</button>
            <button class="add-song-btn" onclick="openAddSongModal()">+ Add Song</button>
        </div>

        <div class="songs-container" id="songsContainer">
            <div class="songs-list" id="songsList"></div>
        </div>
    </div>

    <!-- Song View Screen -->
    <div class="song-view-screen" id="songViewScreen">
        <div class="song-view-header">
            <div class="song-view-controls">
                <button class="control-btn" onclick="closeSongView()">‚Üê Back to List</button>
                <button class="control-btn" onclick="shuffleSong()">üîÄ Next Random</button>
                <button class="control-btn" onclick="editCurrentSong()">‚úèÔ∏è Edit</button>
                <button class="control-btn" onclick="deleteCurrentSong()">üóëÔ∏è Delete</button>
                <button class="control-btn" onclick="printSong()">üñ®Ô∏è Print</button>
            </div>

            <div class="song-info-section">
                <img id="viewAlbumArt" class="song-album-art" src="" alt="Album Art">
                <div class="song-details">
                    <h1 class="song-title-view" id="viewSongTitle"></h1>
                    <p class="song-artist-view" id="viewSongArtist"></p>
                    <div class="capo-info" id="viewCapo"></div>
                    
                    <div class="capo-transpose">
                        <label>Transpose to Capo:</label>
                        <select class="capo-select" id="capoTranspose" onchange="transposeChords()">
                            <option value="0">No Capo</option>
                            <option value="1">Capo 1</option>
                            <option value="2">Capo 2</option>
                            <option value="3">Capo 3</option>
                            <option value="4">Capo 4</option>
                            <option value="5">Capo 5</option>
                            <option value="6">Capo 6</option>
                            <option value="7">Capo 7</option>
                            <option value="8">Capo 8</option>
                        </select>
                    </div>

                    <div class="chords-list" id="viewChordsList"></div>
                </div>
            </div>
        </div>

        <div class="youtube-container" id="youtubeContainer" style="display:none;">
            <iframe id="youtubePlayer" class="youtube-player" src="" frameborder="0" allowfullscreen></iframe>
        </div>

        <div class="song-content" id="songContent"></div>

        <div class="scroll-controls">
            <button class="scroll-btn" id="scrollBtn" onclick="toggleAutoScroll()">‚ñ∂ Start Scroll</button>
            <div class="scroll-speed">
                <label>Speed:</label>
                <input type="range" class="speed-slider" id="scrollSpeed" min="1" max="10" value="5">
                <span id="speedValue">5</span>
            </div>
            <div class="text-size-control">
                <button class="size-btn" onclick="changeTextSize(-2)">A-</button>
                <button class="size-btn" onclick="changeTextSize(2)">A+</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Song Modal -->
    <div class="modal" id="songModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Song</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('upload')">Upload Image</button>
                <button class="tab-btn" onclick="switchTab('manual')">Manual Entry</button>
            </div>

            <div class="tab-content active" id="uploadTab">
                <div class="upload-zone" id="uploadZone">
                    <p style="font-size: 1.2em; margin-bottom: 10px;">üì∏ Click or Drag & Drop Image</p>
                    <p style="color: #718096;">Upload a picture of your song with chords</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>
                <img id="previewImage" class="preview-image hidden" src="" alt="Preview">
                <p id="processingText" class="processing-text hidden">Processing image...</p>
            </div>

            <div class="tab-content" id="manualTab">
                <div class="form-group">
                    <label>Song Title*</label>
                    <input type="text" id="songTitle" required>
                </div>

                <div class="form-group">
                    <label>Artist Name*</label>
                    <input type="text" id="artistName" required>
                </div>

                <div class="form-group">
                    <label>Album Image URL</label>
                    <input type="text" id="albumImage" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label>Capo Position</label>
                    <select id="capoPosition">
                        <option value="0">No Capo</option>
                        <option value="1">Capo 1</option>
                        <option value="2">Capo 2</option>
                        <option value="3">Capo 3</option>
                        <option value="4">Capo 4</option>
                        <option value="5">Capo 5</option>
                        <option value="6">Capo 6</option>
                        <option value="7">Capo 7</option>
                        <option value="8">Capo 8</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>YouTube URL</label>
                    <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=...">
                </div>

                <div class="form-group">
                    <label>Lyrics with Chords*</label>
                    <textarea id="lyricsChords" placeholder="Type chords on their own line, then lyrics below:

C
Why must I go to bed at 8
F                    G
When Esti's up till 9?"></textarea>
                </div>

                <button class="submit-btn" onclick="saveSong()">Save Song</button>
            </div>
        </div>
    </div>

    <!-- Tuner Modal -->
    <div class="modal" id="tunerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Guitar Tuner</h2>
                <button class="close-modal" onclick="closeTuner()">&times;</button>
            </div>

            <div class="tuner-screen">
                <div class="tuner-note" id="tunerNote">Select a string</div>
                
                <div class="string-buttons">
                    <button class="string-btn" onclick="selectString('E', 82.41)">E</button>
                    <button class="string-btn" onclick="selectString('A', 110.00)">A</button>
                    <button class="string-btn" onclick="selectString('D', 146.83)">D</button>
                    <button class="string-btn" onclick="selectString('G', 196.00)">G</button>
                    <button class="string-btn" onclick="selectString('B', 246.94)">B</button>
                    <button class="string-btn" onclick="selectString('E', 329.63)">e</button>
                </div>

                <div class="tuner-display">
                    <div class="tuner-meter">
                        <div class="tuner-needle" id="tunerNeedle"></div>
                    </div>
                    <div class="tuner-marks">
                        <span>-20</span>
                        <span>-10</span>
                        <span style="font-size: 1.2em; color: #48bb78;">0</span>
                        <span>+10</span>
                        <span>+20</span>
                    </div>
                    <div class="tuner-status" id="tunerStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let appState = {
            currentCategory: null,
            browseMode: 'name',
            songs: [],
            currentSong: null,
            isScrolling: false,
            scrollInterval: null,
            textSize: 16,
            editingId: null,
            tunerActive: false,
            audioContext: null,
            analyser: null,
            targetFrequency: null,
            selectedString: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSongs();
            setupUploadZone();
            document.getElementById('scrollSpeed').addEventListener('input', (e) => {
                document.getElementById('speedValue').textContent = e.target.value;
            });
        });

        // Storage Functions
        function loadSongs() {
            const stored = localStorage.getItem('guitarChordsSongs');
            if (stored) {
                appState.songs = JSON.parse(stored);
            }
        }

        function saveSongs() {
            localStorage.setItem('guitarChordsSongs', JSON.stringify(appState.songs));
        }

        // Category Selection
        function selectCategory(category) {
            appState.currentCategory = category;
            document.getElementById('categoryScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('categoryTitle').textContent = 
                category === 'jewish' ? 'Jewish Music' : 'Non-Jewish Music';
            displaySongs();
        }

        function goBackToCategories() {
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('categoryScreen').style.display = 'flex';
            appState.currentCategory = null;
        }

        // Browse Mode
        function setBrowseMode(mode) {
            appState.browseMode = mode;
            document.querySelectorAll('.browse-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displaySongs();
        }

        // Display Songs
        function displaySongs() {
            const container = document.getElementById('songsList');
            const filtered = appState.songs.filter(s => s.category === appState.currentCategory);
            
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#718096;padding:40px;">No songs yet. Add your first song!</p>';
                return;
            }

            if (appState.browseMode === 'name') {
                const sorted = filtered.sort((a, b) => a.title.localeCompare(b.title));
                sorted.forEach(song => {
                    container.appendChild(createSongItem(song));
                });
            } else {
                const byArtist = {};
                filtered.forEach(song => {
                    if (!byArtist[song.artist]) {
                        byArtist[song.artist] = [];
                    }
                    byArtist[song.artist].push(song);
                });

                const sortedArtists = Object.keys(byArtist).sort();
                sortedArtists.forEach(artist => {
                    const group = document.createElement('div');
                    group.className = 'artist-group';
                    
                    const header = document.createElement('div');
                    header.className = 'artist-header';
                    header.textContent = artist;
                    group.appendChild(header);

                    byArtist[artist].sort((a, b) => a.title.localeCompare(b.title))
                        .forEach(song => {
                            group.appendChild(createSongItem(song));
                        });

                    container.appendChild(group);
                });
            }
        }

        function createSongItem(song) {
            const item = document.createElement('div');
            item.className = 'song-item';
            item.onclick = () => openSong(song);

            const img = document.createElement('img');
            img.src = song.albumArt || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23e2e8f0" width="60" height="60"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23718096" font-size="24">üéµ</text></svg>';
            img.onerror = function() {
                this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60"><rect fill="%23e2e8f0" width="60" height="60"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23718096" font-size="24">üéµ</text></svg>';
            };

            const info = document.createElement('div');
            info.className = 'song-item-info';
            info.innerHTML = `
                <div class="song-item-title">${song.title}</div>
                <div class="song-item-artist">${song.artist}</div>
            `;

            item.appendChild(img);
            item.appendChild(info);
            return item;
        }

        // Search
        function searchSongs() {
            const query = document.getElementById('searchBox').value.toLowerCase();
            const items = document.querySelectorAll('.song-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        // Shuffle
        function shuffleSong() {
            const filtered = appState.songs.filter(s => s.category === appState.currentCategory);
            if (filtered.length === 0) {
                alert('No songs in this category yet!');
                return;
            }
            const random = filtered[Math.floor(Math.random() * filtered.length)];
            openSong(random);
        }

        // Open Song
        function openSong(song) {
            appState.currentSong = song;
            
            // Load saved transpose setting
            const savedTranspose = localStorage.getItem(`transpose_${song.id}`);
            const capoValue = savedTranspose !== null ? parseInt(savedTranspose) : song.capo;
            
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('songViewScreen').style.display = 'block';
            
            document.getElementById('viewSongTitle').textContent = song.title;
            document.getElementById('viewSongArtist').textContent = song.artist;
            document.getElementById('viewCapo').textContent = `Original Capo: ${song.capo}`;
            document.getElementById('viewAlbumArt').src = song.albumArt || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect fill="%23e2e8f0" width="150" height="150"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23718096" font-size="48">üéµ</text></svg>';
            
            document.getElementById('capoTranspose').value = capoValue;
            
            // YouTube
            if (song.youtube) {
                const videoId = extractYouTubeId(song.youtube);
                if (videoId) {
                    document.getElementById('youtubeContainer').style.display = 'block';
                    document.getElementById('youtubePlayer').src = `https://www.youtube.com/embed/${videoId}`;
                } else {
                    document.getElementById('youtubeContainer').style.display = 'none';
                }
            } else {
                document.getElementById('youtubeContainer').style.display = 'none';
            }
            
            displaySongContent(song, capoValue);
            updateChordsList(song, capoValue);
        }

        function extractYouTubeId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/,
                /youtube\.com\/embed\/([^&\s]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function displaySongContent(song, currentCapo) {
            const container = document.getElementById('songContent');
            const transposeDiff = currentCapo - song.capo;
            const lines = song.lyrics.split('\n');
            
            let html = '';
            lines.forEach(line => {
                if (isChordLine(line)) {
                    const transposed = transposeLine(line, transposeDiff);
                    html += `<div class="chord-line">${transposed}</div>`;
                } else {
                    html += `<div class="lyric-line">${line}</div>`;
                }
            });
            
            container.innerHTML = html;
            container.style.setProperty('--text-size', `${appState.textSize}px`);
        }

        function isChordLine(line) {
            const chordPattern = /\b[A-G](#|b)?(m|maj|min|dim|aug|sus|add)?[0-9]?(?![a-z])/;
            const words = line.trim().split(/\s+/);
            if (words.length === 0) return false;
            
            const chordWords = words.filter(w => chordPattern.test(w));
            return chordWords.length > 0 && chordWords.length / words.length > 0.5;
        }

        function transposeLine(line, semitones) {
            if (semitones === 0) return line;
            
            const chordPattern = /\b([A-G](#|b)?)(m|maj|min|dim|aug|sus|add)?([0-9]?)\b/g;
            
            return line.replace(chordPattern, (match, root, modifier = '', suffix = '', number = '') => {
                const transposed = transposeChord(root + modifier, semitones);
                return transposed + suffix + number;
            });
        }

        function transposeChord(chord, semitones) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const flats = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            
            let baseNote = chord.replace(/b|#/, '');
            let modifier = chord.includes('#') ? '#' : (chord.includes('b') ? 'b' : '');
            
            let noteArray = modifier === 'b' ? flats : notes;
            let index = noteArray.indexOf(chord);
            
            if (index === -1) return chord;
            
            let newIndex = (index + semitones + 12) % 12;
            return noteArray[newIndex];
        }

        function updateChordsList(song, currentCapo) {
            const container = document.getElementById('viewChordsList');
            const transposeDiff = currentCapo - song.capo;
            const chords = extractChords(song.lyrics, transposeDiff);
            
            container.innerHTML = '';
            chords.forEach(chord => {
                const tag = document.createElement('span');
                tag.className = 'chord-tag';
                tag.textContent = chord;
                container.appendChild(tag);
            });
        }

        function extractChords(lyrics, transposeDiff) {
            const chordSet = new Set();
            const lines = lyrics.split('\n');
            const chordPattern = /\b([A-G](#|b)?)(m|maj|min|dim|aug|sus|add)?([0-9]?)\b/g;
            
            lines.forEach(line => {
                if (isChordLine(line)) {
                    let match;
                    while ((match = chordPattern.exec(line)) !== null) {
                        const fullChord = match[0];
                        const root = match[1] + (match[2] || '');
                        const suffix = (match[3] || '') + (match[4] || '');
                        const transposed = transposeChord(root, transposeDiff) + suffix;
                        chordSet.add(transposed);
                    }
                }
            });
            
            return Array.from(chordSet);
        }

        function transposeChords() {
            const newCapo = parseInt(document.getElementById('capoTranspose').value);
            localStorage.setItem(`transpose_${appState.currentSong.id}`, newCapo);
            displaySongContent(appState.currentSong, newCapo);
            updateChordsList(appState.currentSong, newCapo);
        }

        function closeSongView() {
            document.getElementById('songViewScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            stopAutoScroll();
            
            // Stop YouTube
            document.getElementById('youtubePlayer').src = '';
        }

        // Auto Scroll
        function toggleAutoScroll() {
            if (appState.isScrolling) {
                stopAutoScroll();
            } else {
                startAutoScroll();
            }
        }

        function startAutoScroll() {
            appState.isScrolling = true;
            document.getElementById('scrollBtn').textContent = '‚è∏ Stop Scroll';
            document.getElementById('scrollBtn').classList.add('stop');
            
            const speed = parseInt(document.getElementById('scrollSpeed').value);
            const scrollAmount = speed * 0.5;
            
            appState.scrollInterval = setInterval(() => {
                window.scrollBy(0, scrollAmount);
            }, 50);
        }

        function stopAutoScroll() {
            appState.isScrolling = false;
            document.getElementById('scrollBtn').textContent = '‚ñ∂ Start Scroll';
            document.getElementById('scrollBtn').classList.remove('stop');
            
            if (appState.scrollInterval) {
                clearInterval(appState.scrollInterval);
                appState.scrollInterval = null;
            }
        }

        // Text Size
        function changeTextSize(delta) {
            appState.textSize = Math.max(12, Math.min(32, appState.textSize + delta));
            document.getElementById('songContent').style.setProperty('--text-size', `${appState.textSize}px`);
        }

        // Print
        function printSong() {
            window.print();
        }

        // Modal Functions
        function openAddSongModal() {
            appState.editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Song';
            document.getElementById('songTitle').value = '';
            document.getElementById('artistName').value = '';
            document.getElementById('albumImage').value = '';
            document.getElementById('capoPosition').value = '0';
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('lyricsChords').value = '';
            document.getElementById('previewImage').classList.add('hidden');
            document.getElementById('processingText').classList.add('hidden');
            document.getElementById('songModal').classList.add('active');
        }

        function editCurrentSong() {
            const song = appState.currentSong;
            appState.editingId = song.id;
            
            document.getElementById('modalTitle').textContent = 'Edit Song';
            document.getElementById('songTitle').value = song.title;
            document.getElementById('artistName').value = song.artist;
            document.getElementById('albumImage').value = song.albumArt || '';
            document.getElementById('capoPosition').value = song.capo;
            document.getElementById('youtubeUrl').value = song.youtube || '';
            document.getElementById('lyricsChords').value = song.lyrics;
            
            switchTab('manual');
            document.getElementById('songModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('songModal').classList.remove('active');
            appState.editingId = null;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'upload') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('uploadTab').classList.add('active');
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('manualTab').classList.add('active');
            }
        }

        // Image Upload
        function setupUploadZone() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('imageUpload');
            
            zone.onclick = () => input.click();
            
            zone.ondragover = (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            };
            
            zone.ondragleave = () => {
                zone.classList.remove('dragover');
            };
            
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processImage(file);
                }
            };
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processImage(file);
            }
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('previewImage');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                
                document.getElementById('processingText').classList.remove('hidden');
                
                // OCR Processing
                Tesseract.recognize(
                    e.target.result,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                document.getElementById('processingText').textContent = 
                                    `Processing... ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    document.getElementById('processingText').classList.add('hidden');
                    
                    // Switch to manual tab with extracted text
                    switchTab('manual');
                    document.getElementById('lyricsChords').value = text;
                    
                    alert('Text extracted! Please review and edit as needed.');
                }).catch(err => {
                    console.error('OCR Error:', err);
                    document.getElementById('processingText').textContent = 'Error processing image. Please try manual entry.';
                    document.getElementById('processingText').style.color = '#f56565';
                });
            };
            reader.readAsDataURL(file);
        }

        // Save Song
        function saveSong() {
            const title = document.getElementById('songTitle').value.trim();
            const artist = document.getElementById('artistName').value.trim();
            const lyrics = document.getElementById('lyricsChords').value.trim();
            
            if (!title || !artist || !lyrics) {
                alert('Please fill in Song Title, Artist, and Lyrics with Chords');
                return;
            }
            
            const song = {
                id: appState.editingId || Date.now().toString(),
                category: appState.currentCategory,
                title,
                artist,
                albumArt: document.getElementById('albumImage').value.trim(),
                capo: parseInt(document.getElementById('capoPosition').value),
                youtube: document.getElementById('youtubeUrl').value.trim(),
                lyrics
            };
            
            if (appState.editingId) {
                const index = appState.songs.findIndex(s => s.id === appState.editingId);
                appState.songs[index] = song;
            } else {
                appState.songs.push(song);
            }
            
            saveSongs();
            closeModal();
            
            if (appState.editingId) {
                openSong(song);
            } else {
                displaySongs();
            }
        }

        function deleteCurrentSong() {
            if (!confirm('Are you sure you want to delete this song?')) return;
            
            appState.songs = appState.songs.filter(s => s.id !== appState.currentSong.id);
            saveSongs();
            closeSongView();
            displaySongs();
        }

        // Tuner Functions
        function openTuner() {
            document.getElementById('tunerModal').classList.add('active');
            if (!appState.audioContext) {
                setupAudioContext();
            }
        }

        function closeTuner() {
            document.getElementById('tunerModal').classList.remove('active');
            stopTuner();
        }

        async function setupAudioContext() {
            try {
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                appState.analyser = appState.audioContext.createAnalyser();
                appState.analyser.fftSize = 4096;
            } catch (err) {
                console.error('Audio context error:', err);
                alert('Unable to access audio. Please check your browser permissions.');
            }
        }

        async function selectString(note, frequency) {
            // Remove active from all buttons
            document.querySelectorAll('.string-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            appState.selectedString = note;
            appState.targetFrequency = frequency;
            document.getElementById('tunerNote').textContent = note;
            
            // Start listening
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = appState.audioContext.createMediaStreamSource(stream);
                source.connect(appState.analyser);
                
                appState.tunerActive = true;
                updateTuner();
            } catch (err) {
                console.error('Microphone error:', err);
                alert('Unable to access microphone. Please check permissions.');
            }
        }

        function updateTuner() {
            if (!appState.tunerActive) return;
            
            const bufferLength = appState.analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            appState.analyser.getFloatTimeDomainData(buffer);
            
            const frequency = autoCorrelate(buffer, appState.audioContext.sampleRate);
            
            if (frequency > 0 && appState.targetFrequency) {
                const cents = 1200 * Math.log2(frequency / appState.targetFrequency);
                updateTunerDisplay(cents);
            }
            
            requestAnimationFrame(updateTuner);
        }

        function autoCorrelate(buffer, sampleRate) {
            let size = buffer.length;
            let maxSamples = Math.floor(size / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;
            
            for (let i = 0; i < size; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / size);
            
            if (rms < 0.01) return -1;
            
            let lastCorrelation = 1;
            for (let offset = 1; offset < maxSamples; offset++) {
                let correlation = 0;
                for (let i = 0; i < maxSamples; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / maxSamples);
                
                if (correlation > 0.9 && correlation > lastCorrelation) {
                    let foundGoodCorrelation = false;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                        foundGoodCorrelation = correlation > 0.9;
                    }
                    if (foundGoodCorrelation) {
                        let shift = (buffer[bestOffset + 1] - buffer[bestOffset - 1]) / buffer[bestOffset];
                        return sampleRate / (bestOffset + (8 * shift));
                    }
                }
                lastCorrelation = correlation;
            }
            
            if (bestCorrelation > 0.01) {
                return sampleRate / bestOffset;
            }
            return -1;
        }

        function updateTunerDisplay(cents) {
            const needle = document.getElementById('tunerNeedle');
            const status = document.getElementById('tunerStatus');
            
            // Clamp cents to -50 to +50 range for display
            const clampedCents = Math.max(-50, Math.min(50, cents));
            
            // Convert cents to pixel position (0-100% of meter width)
            const position = 50 + clampedCents; // 50% is center
            needle.style.left = `${position}%`;
            
            // Update status
            if (Math.abs(cents) < 5) {
                status.textContent = '‚úì IN TUNE';
                status.className = 'tuner-status in-tune';
                needle.style.background = '#48bb78';
                
                // Play success sound
                playTone(appState.targetFrequency, 0.1, 0.3);
            } else if (cents < 0) {
                status.textContent = '‚Üì TOO FLAT';
                status.className = 'tuner-status flat';
                needle.style.background = '#f56565';
            } else {
                status.textContent = '‚Üë TOO SHARP';
                status.className = 'tuner-status sharp';
                needle.style.background = '#ed8936';
            }
        }

        function playTone(frequency, duration, volume = 0.3) {
            const oscillator = appState.audioContext.createOscillator();
            const gainNode = appState.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(appState.audioContext.destination);
            
            oscillator.frequency.value = frequency;
            gainNode.gain.value = volume;
            
            oscillator.start();
            setTimeout(() => oscillator.stop(), duration * 1000);
        }

        function stopTuner() {
            appState.tunerActive = false;
            appState.selectedString = null;
            appState.targetFrequency = null;
            document.getElementById('tunerStatus').textContent = '';
            document.getElementById('tunerNote').textContent = 'Select a string';
            document.querySelectorAll('.string-btn').forEach(btn => btn.classList.remove('active'));
        }
    </script>
</body>
</html>
